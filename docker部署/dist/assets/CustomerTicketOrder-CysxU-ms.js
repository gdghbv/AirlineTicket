import{g as te,o as ae,b as le}from"./customer-BTYy29KR.js";import{C as re}from"./CustomerNavBar-DBTpX4Q2.js";import{g as oe}from"./request-DuNoOhOk.js";import{_ as ie,x as V,r as g,y as ne,g as se,c as S,d as e,w as a,e as m,E as k,u as de,z as ue,o as z,f as o,m as pe,a as ce,h as me,t as s,i as fe,p as _e}from"./index-DuoLJuUX.js";import"./userInfo-BeHjQlXh.js";import"./index-6vGxE6Be.js";import"./airport-DZ6oIf4n.js";const ge={class:"ticket-order-root"},be={class:"pagination-bar"},ve={key:0},ye={key:0},De={key:1},ze={__name:"CustomerTicketOrder",setup(he){const O=de(),u=V({departureKeyword:"",arrivalKeyword:"",dateKeyword:"",pageNum:1,pageSize:10}),w=g([{airlineId:"",departure:"",departureAirportName:"",arrival:"",arrivalAirportName:"",date:"",departureTime:"",arrivalTime:"",duration:"",price:"",boardingGate:"",firstSeat:"",secondSeat:"",thirdSeat:"",departureAirportPhone:"",arrivalAirportPhone:"",firstSeatPrice:"",secondSeatPrice:"",thirdSeatPrice:""}]),x=g(0),T=g(!1);function v(){T.value=!0,te({...u,pageNum:u.pageNum,pageSize:u.pageSize}).then(l=>{Array.isArray(l.pageData)?w.value=l.pageData:w.value=[],x.value=l.totalSize||0}).catch(l=>{console.error("获取航班信息失败:",l),k.error("获取航班信息失败")}).finally(()=>{T.value=!1})}v();function B(l){u.pageSize=l,u.pageNum=1,v()}function F(l){u.pageNum=l,v()}const h=g(!1),d=V({});function E(l){Object.assign(d,l),h.value=!0}const y=g(!1),r=V({citizenId:"",citizenName:"",seatType:"",useDiscount:!1}),n=V({price:null,discount:0,priceData:{}}),A=ne(()=>!!(r.citizenId&&r.citizenName&&r.seatType&&n.price!==null&&n.price!==void 0));let I=null;const D=g(),C=g(!1);function R(l){if(!oe()){k.warning("请先登录！"),setTimeout(()=>{O.push("/login")},800);return}Y(l)}function Y(l){I=l,r.citizenId="",r.citizenName="",r.seatType="",r.useDiscount=!1,n.price=null,n.discount=0,n.priceData={},le(l).then(t=>{console.log("getPrice后端返回:",t);const p=t||{};n.priceData=p,r.seatType="经济舱",r.useDiscount=!0,N()}),y.value=!0}function q(){N()}function M(){N()}function N(){const l=n.priceData;if(!r.seatType||!l){n.price=null,n.discount=0;return}let t=0,p=0,f=0;r.seatType==="头等舱"?(f=l.firstSeatPrice,t=r.useDiscount?l.firstSeatDiscountPrice:l.firstSeatPrice,p=r.useDiscount?l.firstSeatDiscount:0):r.seatType==="商务舱"?(f=l.secondSeatPrice,t=r.useDiscount?l.secondSeatDiscountPrice:l.secondSeatPrice,p=r.useDiscount?l.secondSeatDiscount:0):r.seatType==="经济舱"&&(f=l.thirdSeatPrice,t=r.useDiscount?l.thirdSeatDiscountPrice:l.thirdSeatPrice,p=r.useDiscount?l.thirdSeatDiscount:0),n.price=t,n.discount=p,console.log(`当前舱型: ${r.seatType}, 优惠前: ${f}, 优惠后: ${t}, 优惠: ${p}`)}se(r,()=>{D.value&&D.value.validate(l=>{C.value=!l})},{deep:!0});const j={citizenId:[{required:!0,message:"请输入身份证号",trigger:"blur"},{pattern:/^\d{17}[\dX]$/i,message:"身份证号格式不正确",trigger:"blur"}],citizenName:[{required:!0,message:"请输入乘机人姓名",trigger:"blur"},{min:2,max:10,message:"乘机人姓名长度在2到10个字符之间",trigger:"blur"}],seatType:[{required:!0,message:"请选择舱型",trigger:"change"}]};function G(){D.value&&D.value.validate(l=>{if(!l)return;const t={airlineId:I.airlineId,seatType:r.seatType,citizenId:r.citizenId,citizenName:r.citizenName,spending:n.price,discount:r.useDiscount?n.discount:0};ae(t).then(p=>{k.success("购票成功！"),y.value=!1,v()}).catch(p=>{k.error("购票失败："+(p.message||"未知错误"))})})}return(l,t)=>{const p=m("el-input"),f=m("el-form-item"),L=m("el-date-picker"),b=m("el-button"),K=m("el-form"),U=m("el-card"),_=m("el-table-column"),X=m("el-table"),H=m("el-pagination"),c=m("el-descriptions-item"),J=m("el-descriptions"),$=m("el-dialog"),P=m("el-option"),Q=m("el-select"),W=m("el-checkbox"),Z=ue("loading");return z(),S("div",ge,[e(re),e(U,{class:"search-box"},{default:a(()=>[e(K,{inline:!0,model:u,class:"search-form"},{default:a(()=>[e(f,{label:"起点"},{default:a(()=>[e(p,{modelValue:u.departureKeyword,"onUpdate:modelValue":t[0]||(t[0]=i=>u.departureKeyword=i),placeholder:"请输入起点",clearable:""},null,8,["modelValue"])]),_:1}),e(f,{label:"终点"},{default:a(()=>[e(p,{modelValue:u.arrivalKeyword,"onUpdate:modelValue":t[1]||(t[1]=i=>u.arrivalKeyword=i),placeholder:"请输入终点",clearable:""},null,8,["modelValue"])]),_:1}),e(f,{label:"起飞日期"},{default:a(()=>[e(L,{modelValue:u.dateKeyword,"onUpdate:modelValue":t[2]||(t[2]=i=>u.dateKeyword=i),type:"date",placeholder:"选择日期","value-format":"YYYY-MM-DD",clearable:""},null,8,["modelValue"])]),_:1}),e(f,null,{default:a(()=>[e(b,{type:"primary",onClick:v},{default:a(()=>t[11]||(t[11]=[o("搜索")])),_:1,__:[11]})]),_:1})]),_:1},8,["model"])]),_:1}),e(U,{class:"airline-list-box"},{default:a(()=>[pe((z(),me(X,{data:w.value,stripe:"",border:"",style:{width:"100%"}},{default:a(()=>[e(_,{prop:"airlineId",label:"航班号",width:"90"}),e(_,{prop:"departure",label:"起点",width:"90"}),e(_,{prop:"departureAirportName",label:"起飞机场","min-width":"120"}),e(_,{prop:"arrival",label:"终点",width:"90"}),e(_,{prop:"arrivalAirportName",label:"到达机场","min-width":"120"}),e(_,{prop:"date",label:"日期",width:"110"}),e(_,{prop:"departureTime",label:"起飞时间",width:"90"}),e(_,{prop:"arrivalTime",label:"到达时间",width:"90"}),e(_,{prop:"duration",label:"时长",width:"80"}),e(_,{prop:"price",label:"票价(元)",width:"100"}),e(_,{label:"操作",width:"180"},{default:a(({row:i})=>[e(b,{type:"success",size:"small",onClick:ee=>R(i)},{default:a(()=>t[12]||(t[12]=[o("购买")])),_:2,__:[12]},1032,["onClick"]),e(b,{type:"primary",size:"small",onClick:ee=>E(i),style:{"margin-left":"8px"}},{default:a(()=>t[13]||(t[13]=[o("查看详情")])),_:2,__:[13]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Z,T.value]]),ce("div",be,[e(H,{background:"",layout:"sizes, prev, pager, next, jumper",total:x.value,"page-size":u.pageSize,"current-page":u.pageNum,"page-sizes":[7,10,20],onSizeChange:B,onCurrentChange:F},null,8,["total","page-size","current-page"])])]),_:1}),e($,{modelValue:h.value,"onUpdate:modelValue":t[4]||(t[4]=i=>h.value=i),title:"航班详情",width:"480px","close-on-click-modal":!1},{footer:a(()=>[e(b,{onClick:t[3]||(t[3]=i=>h.value=!1)},{default:a(()=>t[14]||(t[14]=[o("关闭")])),_:1,__:[14]})]),default:a(()=>[e(J,{column:1,border:""},{default:a(()=>[e(c,{label:"航班号"},{default:a(()=>[o(s(d.airlineId),1)]),_:1}),e(c,{label:"起点"},{default:a(()=>[o(s(d.departure),1)]),_:1}),e(c,{label:"起飞机场"},{default:a(()=>[o(s(d.departureAirportName),1)]),_:1}),e(c,{label:"终点"},{default:a(()=>[o(s(d.arrival),1)]),_:1}),e(c,{label:"到达机场"},{default:a(()=>[o(s(d.arrivalAirportName),1)]),_:1}),e(c,{label:"日期"},{default:a(()=>[o(s(d.date),1)]),_:1}),e(c,{label:"起飞时间"},{default:a(()=>[o(s(d.departureTime),1)]),_:1}),e(c,{label:"到达时间"},{default:a(()=>[o(s(d.arrivalTime),1)]),_:1}),e(c,{label:"时长"},{default:a(()=>[o(s(d.duration),1)]),_:1}),e(c,{label:"登机口"},{default:a(()=>[o(s(d.boardingGate),1)]),_:1}),e(c,{label:"头等舱票价"},{default:a(()=>[o(s(d.firstSeatPrice)+" 元",1)]),_:1}),e(c,{label:"商务舱票价"},{default:a(()=>[o(s(d.secondSeatPrice)+" 元",1)]),_:1}),e(c,{label:"经济舱票价"},{default:a(()=>[o(s(d.thirdSeatPrice)+" 元",1)]),_:1}),e(c,{label:"起飞机场电话"},{default:a(()=>[o(s(d.departureAirportPhone),1)]),_:1}),e(c,{label:"降落机场电话"},{default:a(()=>[o(s(d.arrivalAirportPhone),1)]),_:1})]),_:1})]),_:1},8,["modelValue"]),e($,{modelValue:y.value,"onUpdate:modelValue":t[10]||(t[10]=i=>y.value=i),title:"填写购票信息",width:"420px","close-on-click-modal":!1},{footer:a(()=>[e(b,{onClick:t[9]||(t[9]=i=>y.value=!1)},{default:a(()=>t[16]||(t[16]=[o("取消")])),_:1,__:[16]}),e(b,{type:"primary",disabled:!A.value||C.value,onClick:G,class:_e({"disabled-btn":!A.value||C.value})},{default:a(()=>t[17]||(t[17]=[o("确认购买")])),_:1,__:[17]},8,["disabled","class"])]),default:a(()=>[e(K,{model:r,"label-width":"90px",rules:j,ref_key:"orderFormRef",ref:D},{default:a(()=>[e(f,{label:"身份证号",prop:"citizenId"},{default:a(()=>[e(p,{modelValue:r.citizenId,"onUpdate:modelValue":t[5]||(t[5]=i=>r.citizenId=i),maxlength:"18",placeholder:"请输入乘机人身份证号"},null,8,["modelValue"])]),_:1}),e(f,{label:"乘机人姓名",prop:"citizenName"},{default:a(()=>[e(p,{modelValue:r.citizenName,"onUpdate:modelValue":t[6]||(t[6]=i=>r.citizenName=i),maxlength:"10",placeholder:"请输入乘机人姓名"},null,8,["modelValue"])]),_:1}),e(f,{label:"舱型",prop:"seatType"},{default:a(()=>[e(Q,{modelValue:r.seatType,"onUpdate:modelValue":t[7]||(t[7]=i=>r.seatType=i),placeholder:"请选择舱型",onChange:q},{default:a(()=>[e(P,{label:"头等舱",value:"头等舱"}),e(P,{label:"商务舱",value:"商务舱"}),e(P,{label:"经济舱",value:"经济舱"})]),_:1},8,["modelValue"]),e(W,{modelValue:r.useDiscount,"onUpdate:modelValue":t[8]||(t[8]=i=>r.useDiscount=i),style:{"margin-left":"16px"},onChange:M},{default:a(()=>t[15]||(t[15]=[o("使用优惠")])),_:1,__:[15]},8,["modelValue"])]),_:1}),e(f,{label:"实际价格"},{default:a(()=>[n.price!==null&&n.price!==void 0?(z(),S("span",ve,[o(s(n.price)+" 元 ",1),n.discount&&n.discount>0?(z(),S("span",ye,"(已优惠 "+s(n.discount)+" 元)",1)):fe("",!0)])):(z(),S("span",De,"请选择舱型"))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Pe=ie(ze,[["__scopeId","data-v-991ffc49"]]);export{Pe as default};
